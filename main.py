import yaylib
import random
import time
import os
from datetime import datetime

# 環境変数からアカウント情報を取得
account_list = os.getenv('YAY_ACCOUNTS', '').split(',')

# ログイン情報のリスト作成
accounts = []
for account in account_list:
    parts = account.split(':')
    if len(parts) == 2:
        accounts.append({'email': parts[0], 'password': parts[1]})

# 各時間帯の投稿リスト（1時間ごとに8個）
hourly_posts = {
    6: ["おはよ〜！今日も頑張ろっ✨", "ねむい…あと5分寝たい🥱", "朝ごはんはパン派？ごはん派？🍞🍚", "顔洗ったら少しスッキリ！", 
        "もう少し布団にいたいなぁ…", "朝の空気って気持ちいい🌤", "今日の服どうしよ〜👗", "学校or仕事ファイト💪✨"],
    7: ["まだちょっと眠い…🥱", "朝ごはん食べた？🍳", "今日の天気どうかな？", "みんな何時に起きるタイプ？", 
        "朝の準備バタバタする💦", "通勤or通学中〜🚃", "コーヒー飲んで目覚まそ☕️", "今日も楽しい1日になりますように✨"],
    8: ["通勤中〜🚃", "電車混んでる…😵", "カフェでモーニングしてる☕️🍞", "学校or仕事ついた〜！", 
        "朝って時間経つの早いよね😵", "今日の予定なにかある？", "頑張りすぎずにね💖", "週末が待ち遠しい…！"],
    9: ["そろそろお腹すいてきたかも🍙", "仕事or授業中〜📖", "今日の天気いい感じ🌞", "朝のカフェって落ち着く☕️", 
        "集中しなきゃだけど眠い…", "適度に休憩も大事💡", "今日やることメモしよ📝", "お昼なに食べよ〜？"],
    10: ["ちょっと一息つこ☕️", "みんななにしてるの〜？", "そろそろお昼の時間近づいてきたね", "眠くて頭まわらない😂", 
         "集中モードに入ろうかな🔥", "カフェでお仕事or勉強中✍️", "音楽聞きながらリラックス🎶", "誰かと話したいな〜💬"],
    11: ["お昼ごはんどうしよ〜🍚", "ランチ何にしようか迷う🍜", "お昼休みまであとちょっと…", "外食しようかな？", 
         "誰か一緒にランチ行こ〜", "お昼に甘いもの食べたい🍰", "午後もがんばるぞ💪", "お昼寝したくなる時間😪"],
    12: ["ランチなう🍽", "お昼ごはん美味しい〜😋", "午後もがんばるぞー！", "ちょっと眠くなってきた…", 
         "ごはん食べたら元気出た✨", "みんな何食べた？", "デザート食べたい🍦", "午後の予定ある人〜？"],
    # 13:00〜23:00まで同様に作成
    23: ["そろそろ寝る準備しよっかな〜🛁", "夜更かししたい気分🌙", "お風呂あがりのストレッチ中✨", "眠いけどまだ寝たくない😴", 
         "今日も1日お疲れさま💖", "誰かとおしゃべりしたいな〜💬", "そろそろ布団に入ろっかな", "ナイトルーティン中🛀"],
    0: ["夜更かし仲間いる？🙃", "なんか眠れないな〜💭", "深夜のこの時間落ち着くよね🌙", "ひとりで考え事しちゃう時間🌀", 
        "ラジオでも聞こうかな📻", "スマホ見てたら時間が溶ける…", "今夜は寝落ちしそう😪", "夜の音楽って最高🎧"],
    1: ["夜中なのにお腹すいた…", "ちょっと寝落ちしかけてた😴", "今夜は静かでいい感じ🌃", "誰か起きてる〜？💬", 
        "この時間って妙に落ち着く🌙", "夜ふかしの罪悪感😂", "スマホいじってたら朝になりそう💦", "ねむいけど寝たくない〜"],
    2: ["さすがにそろそろ寝なきゃ💤", "ちょっとだけ夜更かし…", "布団が気持ちいい〜", "夜中って変なテンションになる😂", 
        "まだ寝れない人いる〜？", "明日（今日）早起きできるかな…", "深夜ラジオ聞いてる📻", "そろそろ夢の世界へ…"],
    3: ["完全に夜更かしした…", "誰か起きてる？💬", "オールしちゃいそう💦", "この時間の空気好きかも🌃", 
        "ちょっと寝るか悩む🤔", "眠れない夜ってあるよね", "スマホいじってたらこんな時間😂", "そろそろ寝ようかな〜"],
    4: ["夜更かししすぎた😵", "おはよう？いやまだ寝る？😂", "この時間起きてる人いるのかな？", "そろそろ寝なきゃやばい💦", 
        "少しでも寝るか…", "空が少し明るくなってきた🌅", "夜更かしの後悔がすごい😂", "今日も1日頑張るぞー！"],
    5: ["朝が来た〜🌞", "完全に寝不足😂", "眠いけど頑張る💪", "そろそろ朝ごはん食べようかな？", 
        "早起きさんいる？", "今日も一日頑張ろう✨", "なんだかんだ夜更かししちゃった💦", "おはよう世界🌎"]
}

# 4回に1回、投稿の最後に付ける文章
dm_message = " だれかDMしませんか、フォローもお願いします🙏🏻‎🤍"

# 指定された時間帯の投稿リストからランダムに4つ選ぶ
def get_time_based_posts():
    now = datetime.now().hour
    posts = random.sample(hourly_posts[now], 4) if now in hourly_posts else ["なにしてるの〜？💬", "ちょっとおしゃべりしたい💖"]

    # 4回に1回の確率でDM誘導を追加
    for i in range(len(posts)):
        if random.randint(1, 4) == 1:
            posts[i] += dm_message

    return posts

# ログイン処理
yay_clients = []

for account in accounts:
    try:
        client = yaylib.Client()
        client.login(account["email"], account["password"])
        yay_clients.append(client)
    except Exception as e:
        print(f"{account['email']} のログインに失敗: {e}")

# メインの投稿ループ
while True:
    try:
        client = random.choice(yay_clients)
        posts = get_time_based_posts()

        for post_content in posts:
            client.create_post(post_content)
            print(f'投稿しました: {post_content}')
            time.sleep(900)

    except yaylib.errors.HTTPError as e:
        if "429" in str(e):
            time.sleep(random.randint(600, 1800))
        else:
            break
