import yaylib
import random
import time
import os
import threading
from datetime import datetime
import pytz

# --- å…±é€šè¨­å®š ---
jst = pytz.timezone('Asia/Tokyo')

# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
account_list = os.getenv('YAY_ACCOUNTS', '').split(',')
accounts = []
for account in account_list:
    parts = account.split(':')
    if len(parts) == 2:
        accounts.append({'email': parts[0], 'password': parts[1]})

# ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
yay_clients = []
print(f"ğŸŒ ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†é–‹å§‹ï¼ˆ{len(accounts)}ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰")
for account in accounts:
    try:
        client = yaylib.Client()
        client.login(account["email"], account["password"])
        yay_clients.append((client, account["email"]))  # client, email ã‚’ãƒšã‚¢ã§ä¿å­˜
        print(f"âœ… {account['email']} ã§ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ")
    except Exception as e:
        print(f"âŒ {account['email']} ã®ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—: {e}")

if not yay_clients:
    print("ğŸš¨ ãƒ­ã‚°ã‚¤ãƒ³ã§ããŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚çµ‚äº†ã—ã¾ã™ã€‚")
    exit(1)

# --- æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®š ---
post_texts = {
    1: ["ã‚‚ã†1æ™‚ï¼ï¼Ÿæ™‚é–“æ—©ã™ãâ€¦", "æ·±å¤œã®ãƒãƒƒãƒˆã‚µãƒ¼ãƒ•ã‚£ãƒ³ãŒæ­¢ã¾ã‚‰ãªã„"],
    2: ["æ·±å¤œçµ„é›†åˆã€œï¼", "ã‚‚ã†ãã‚ãã‚å¯ãªã„ã¨"],
    3: ["ã“ã®æ™‚é–“èµ·ãã¦ã‚‹ã®ã¯å°‘æ•°æ´¾â€¦ï¼Ÿ", "å®Œå…¨ã«å¤œæ›´ã‹ã—ã—ã™ããŸ"],
    4: ["ãŠã¯ã‚ˆã†ã£ã¦è¨€ã£ã¦ã„ã„ã®ã‹å¾®å¦™ãªæ™‚é–“", "æ—©èµ·ãï¼Ÿãã‚Œã¨ã‚‚å¤œæ›´ã‹ã—ï¼Ÿ"],
    5: ["æœãŒæ¥ãŸã€œ", "å®Œå…¨ã«å¯ä¸è¶³"],
    6: ["ãŠã¯ã‚ˆã€œï¼ä»Šæ—¥ã‚‚é ‘å¼µã‚ã£", "ã­ã‚€ã„â€¦ã‚ã¨5åˆ†å¯ãŸã„"],
    7: ["ã¾ã ã¡ã‚‡ã£ã¨çœ ã„â€¦", "æœã”ã¯ã‚“é£Ÿã¹ãŸï¼Ÿ"],
    8: ["çœ ã™ã", "é›»è»Šæ··ã‚“ã§ã‚‹â€¦"],
    9: ["ãã‚ãã‚ãŠè…¹ã™ã„ã¦ããŸã‹ã‚‚", "ä»•äº‹ä¸­ã ã€œ"],
    10: ["ã¡ã‚‡ã£ã¨ä¸€æ¯ã¤ã“", "ã¿ã‚“ãªãªã«ã—ã¦ã‚‹ã®ã€œï¼Ÿï¼Ÿ"],
    11: ["ãŠæ˜¼ã”ã¯ã‚“ã©ã†ã—ã‚ˆã€œ", "ãƒ©ãƒ³ãƒä½•ã«ã—ã‚ˆã†ã‹è¿·ã†"],
    12: ["ãƒ©ãƒ³ãƒãªã†", "ãŠæ˜¼ã”ã¯ã‚“ç¾å‘³ã—ã™ã"],
    13: ["åˆå¾Œã®ä»•äº‹ã‚¹ã‚¿ãƒ¼ãƒˆï¼ã¿ã‚“ãªãŒã‚“ã°ã‚ã†ã­", "ãƒ©ãƒ³ãƒå¾Œã£ã¦çœ ããªã‚‹ã‚ˆã­"],
    14: ["ã¾ã ãŠæ˜¼ã®çœ æ°—ãŒæŠœã‘ãªã„", "ãã‚ãã‚ãŠã‚„ã¤ã®æ™‚é–“"],
    15: ["ãŠã‚„ã¤ã‚¿ã‚¤ãƒ ã€œ", "ã‚ã¨å°‘ã—ã§çµ‚æ¥­æ™‚é–“â€¦"],
    16: ["ã‚ã¨å°‘ã—ã§ä»•äº‹çµ‚ã‚ã‚‹ï¼ï¼", "å¤•æ–¹ã®ç©ºã£ã¦ç¶ºéº—ã ã‚ˆã­"],
    17: ["ã¿ã‚“ãªãŠã¤ã‹ã‚Œã•ã¾ï¼", "å¤•æ–¹ã®ã“ã®æ™‚é–“ã€å¥½ãã‹ã‚‚"],
    18: ["å¤œã”é£¯ã®æ™‚é–“ã ã€œï¼", "ä»Šæ—¥ã®å¤•é£¯ã¯ä½•ã ã¨æ€ã†ï¼Ÿ"],
    19: ["å¤œã”é£¯é£Ÿã¹çµ‚ã‚ã£ãŸï¼Ÿ", "ã“ã®æ™‚é–“ã¯YouTubeã‹ãƒãƒˆãƒ•ãƒªè¦‹ãŸããªã‚‹"],
    20: ["å¤œã®ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ ", "ãã‚ãã‚ãŠé¢¨å‘‚å…¥ã‚ã†ã‹ãª"],
    21: ["ãã‚ãã‚å¯ã‚‹æº–å‚™ã—ã¦ã‚‹ï¼Ÿ", "ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šä¸­"],
    22: ["å¯ã‚‹å‰ã®ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ ", "å¤œæ›´ã‹ã—ã™ã‚‹äººã€œï¼Ÿ"],
    23: ["ãã‚ãã‚å¯ã‚ˆã†ã‹ãª", "å¤œã£ã¦è‰²ã€…è€ƒãˆã¡ã‚ƒã†ã‚ˆã­"],
    24: ["ã“ã‚“ãªæ™‚é–“ã¾ã§èµ·ãã¦ã‚‹äººã„ã‚‹ï¼Ÿ", "ãã‚ãã‚å¯ã‚‹æº–å‚™ã—ã‚ˆã€œ"]
}

dm_text = " ã€ã ã‚Œã‹DMãã¦ãã ã•ã„ã€‚"

# æ™‚é–“å¸¯ã«å¿œã˜ãŸæŠ•ç¨¿ã‚’å–å¾—
def get_time_based_post():
    now = datetime.now(jst).hour
    if now == 0:
        now = 24  # 0æ™‚ã‚’24æ™‚ã¨ã—ã¦æ‰±ã†
    post = random.choice(post_texts.get(now, ["ã¤ãƒ¼ã‚ã¼ #ã„ã„ã­ã§ã“ã¡ã‚ƒ"]))
    if random.randint(1, 4) == 1:
        post += dm_text
    return post

# æ™‚é–“æŒ‡å®šæŠ•ç¨¿ã®ãƒ«ãƒ¼ãƒ—
def time_based_posting_loop():
    while True:
        print("\nğŸŒŸ æ–°ã—ã„æŠ•ç¨¿ã‚µã‚¤ã‚¯ãƒ«é–‹å§‹")
        for client, email in yay_clients:
            try:
                post = get_time_based_post()
                client.create_post(post)
                print(f"âœ… æŠ•ç¨¿æˆåŠŸ: {email} -> {post}")
            except Exception as e:
                print(f"âŒ æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼ ({email}): {e}")

        print("â³ æ¬¡ã®æŠ•ç¨¿ã¾ã§15åˆ†å¾…æ©Ÿ...")
        time.sleep(900)  # 15åˆ†ã”ã¨ã«æŠ•ç¨¿

# ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹å§‹
threading.Thread(target=time_based_posting_loop, daemon=True).start()

# ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç¶­æŒ
while True:
    time.sleep(1)
