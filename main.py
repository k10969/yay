import yaylib
import random
import time
import os
from datetime import datetime

# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
account_list = os.getenv('YAY_ACCOUNTS', '').split(',')

# ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã®ãƒªã‚¹ãƒˆä½œæˆ
accounts = []
for account in account_list:
    parts = account.split(':')
    if len(parts) == 2:
        accounts.append({'email': parts[0], 'password': parts[1]})

# å„æ™‚é–“å¸¯ã®æŠ•ç¨¿ãƒªã‚¹ãƒˆï¼ˆ1æ™‚é–“ã”ã¨ã«8å€‹ï¼‰
hourly_posts = {
    0: ["ã“ã‚“ãªæ™‚é–“ã¾ã§èµ·ãã¦ã‚‹äººã„ã‚‹ï¼Ÿ", "ãã‚ãã‚å¯ã‚‹æº–å‚™ã—ã‚ˆã€œ", "å¤œæ›´ã‹ã—æœ€é«˜âœ¨", "æ·±å¤œãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚„ã°ã„ğŸ˜‚",
        "å¯ãŸã„ã‘ã©çœ ã‚Œãªã„â€¦", "èª°ã‹è©±ãğŸ’¬", "YouTubeè¦‹ã™ããŸğŸ“±", "ãƒ™ãƒƒãƒ‰ãŒæœ€é«˜ã™ãã‚‹"],
    1: ["ã‚‚ã†1æ™‚ï¼ï¼Ÿæ™‚é–“æ—©ã™ãâ€¦", "æ·±å¤œã®ãƒãƒƒãƒˆã‚µãƒ¼ãƒ•ã‚£ãƒ³ãŒæ­¢ã¾ã‚‰ãªã„", "èª°ã‹é›»è©±ã—ãªã„ï¼ŸğŸ“", "ã‚³ãƒ³ãƒ“ãƒ‹è¡ŒããŸã„ğŸ«",
        "å¤œä¸­ã®ãƒ©ãƒ¼ãƒ¡ãƒ³ã¯æœ€å¼·ğŸœ", "çœ ã‚Œãªã„äººã„ã‚‹ã€œï¼Ÿ", "ãã‚ãã‚å¯ãªã„ã¨ğŸ’¦", "æ˜æ—¥èµ·ãã‚Œã‚‹ã‹ãªâ€¦"],
    2: ["æ·±å¤œçµ„é›†åˆã€œï¼", "ã‚‚ã†ãã‚ãã‚å¯ãªã„ã¨ğŸ˜ª", "YouTubeè¦‹ã¦ãŸã‚‰ã“ã‚“ãªæ™‚é–“ğŸ˜±", "å°è…¹ã™ã„ãŸãªãâ€¦",
        "å¤œä¸­ã«é£Ÿã¹ã‚‹ãŠè“å­ã¯ç½ªã ã‘ã©ç¾å‘³ã„", "æœãŒæ¥ã‚‹å‰ã«å¯ã‚‹ãï¼", "å¯ã‚‹å‰ã«ã‚¹ãƒˆãƒ¬ãƒƒãƒã—ã‚ˆğŸ§˜â€â™€ï¸", "ãƒ©ã‚¸ã‚ªè´ã„ã¦ã‚‹ğŸ“»"],
    3: ["ã“ã®æ™‚é–“èµ·ãã¦ã‚‹ã®ã¯å°‘æ•°æ´¾â€¦ï¼Ÿ", "å®Œå…¨ã«å¤œæ›´ã‹ã—ã—ã™ããŸğŸ˜‚", "3æ™‚ã£ã¦ä¸€ç•ªçœ ããªã‚‹æ™‚é–“â€¦", "ã‚‚ã†å¯ãªãã‚ƒâ€¦",
        "å¤œã®é™ã‘ã•ã£ã¦è½ã¡ç€ãğŸŒ™", "SNSè¦‹ã¦ãŸã‚‰æ™‚é–“æº¶ã‘ãŸğŸ˜µ", "ãã‚ãã‚å¯è½ã¡ã—ãã†ğŸ˜´", "å¤œä¸­ã«è€ƒãˆäº‹ã—ã¡ã‚ƒã†â€¦"],
    4: ["ãŠã¯ã‚ˆã†ã£ã¦è¨€ã£ã¦ã„ã„ã®ã‹å¾®å¦™ãªæ™‚é–“", "æ—©èµ·ãï¼Ÿãã‚Œã¨ã‚‚å¤œæ›´ã‹ã—ï¼Ÿ", "ç©ºãŒå°‘ã—æ˜ã‚‹ããªã£ã¦ããŸğŸŒ…",
        "ãã‚ãã‚æœã®æº–å‚™ã™ã‚‹ã‹â€¦", "ã“ã‚“ãªæ™‚é–“ã«èµ·ãã¦ã‚‹ã®è‡ªåˆ†ã ã‘ï¼Ÿ", "æœã”ã¯ã‚“é£Ÿã¹ã‚‹äººã„ã‚‹ï¼Ÿ", "çœ ã™ãã‚‹â€¦", "ä»Šæ—¥ã®äºˆå®šè€ƒãˆä¸­ğŸ¤”"],
    5: ["æœãŒæ¥ãŸã€œğŸŒ", "å®Œå…¨ã«å¯ä¸è¶³ğŸ˜‚", "çœ ã„ã‘ã©é ‘å¼µã‚‹ğŸ’ª", "ãã‚ãã‚æœã”ã¯ã‚“é£Ÿã¹ã‚ˆã†ã‹ãªï¼Ÿ", 
        "æ—©èµ·ãã•ã‚“ã„ã‚‹ï¼Ÿ", "ä»Šæ—¥ã‚‚ä¸€æ—¥é ‘å¼µã‚ã†âœ¨", "ãªã‚“ã ã‹ã‚“ã å¤œæ›´ã‹ã—ã—ã¡ã‚ƒã£ãŸğŸ’¦", "ãŠã¯ã‚ˆã†ä¸–ç•ŒğŸŒ"],
    6: ["ãŠã¯ã‚ˆãƒ¼ï¼ä»Šæ—¥ã‚‚å…ƒæ°—ã«ï¼", "æœã”ã¯ã‚“ä½•é£Ÿã¹ãŸï¼ŸğŸ", "ä»Šæ—¥ã‚‚ä¸€æ—¥ãƒ•ã‚¡ã‚¤ãƒˆğŸ’ª", "ã¾ã çœ ã„ã‚ˆã€œğŸ˜´",
        "å¸ƒå›£ã‹ã‚‰å‡ºãŸããªã„ğŸ¥¶", "å­¦æ ¡ï¼ˆor ä»•äº‹ï¼‰è¡ŒããŸããªã„â€¦", "æœæ´»ã—ã¦ã‚‹äººã„ã‚‹ï¼Ÿ", "ä»Šæ—¥ã‚‚ã„ã„å¤©æ°—â˜€ï¸"],
    # 7ã€œ22æ™‚ã‚‚åŒã˜ã‚ˆã†ã«ä½œæˆã™ã‚‹ï¼ˆçœç•¥ï¼‰
    23: ["ãã‚ãã‚å¯ã‚‹æ™‚é–“ã‹ãªï¼Ÿ", "ä»Šæ—¥ã‚‚1æ—¥ãŠç–²ã‚Œæ§˜âœ¨", "å¤œã£ã¦ãªã‚“ã‹è½ã¡ç€ãâ€¦", "å¯ã‚‹å‰ã«å°‘ã—ãŠã—ã‚ƒã¹ã‚Šã—ã‚ˆğŸ’¬",
        "ãŠé¢¨å‘‚å…¥ã£ã¦ã‚¹ãƒƒã‚­ãƒªï¼", "ãƒ™ãƒƒãƒ‰ã«å…¥ã£ãŸã‘ã©çœ ã‚Œãªã„ğŸ˜…", "æ˜æ—¥ã®äºˆå®šç¢ºèªã—ãªãã‚ƒ", "ãŠã‚„ã™ã¿ãªã•ã„ğŸ’¤"]
}

# 4å›ã«1å›ã€æŠ•ç¨¿ã®æœ€å¾Œã«ä»˜ã‘ã‚‹æ–‡ç« 
dm_message = " ã ã‚Œã‹DMã—ã¾ã›ã‚“ã‹ã€ãƒ•ã‚©ãƒ­ãƒ¼ã‚‚ãŠé¡˜ã„ã—ã¾ã™ï¼"

# æŒ‡å®šã•ã‚ŒãŸæ™‚é–“å¸¯ã®æŠ•ç¨¿ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«4ã¤é¸ã¶
def get_time_based_posts():
    now = datetime.now().hour
    posts = hourly_posts.get(now, ["ãªã«ã—ã¦ã‚‹ã®ã€œï¼ŸğŸ’¬", "ã¡ã‚‡ã£ã¨ãŠã—ã‚ƒã¹ã‚Šã—ãŸã„ğŸ’–"])

    # ãƒªã‚¹ãƒˆãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«4ã¤é¸ã¶
    if len(posts) >= 4:
        selected_posts = random.sample(posts, 4)
    else:
        selected_posts = posts  # æŠ•ç¨¿ãŒ4ã¤æœªæº€ã®å ´åˆã€ãã®ã¾ã¾ä½¿ç”¨

    # 4å›ã«1å›ã®ç¢ºç‡ã§DMèª˜å°ã‚’è¿½åŠ 
    for i in range(len(selected_posts)):
        if random.randint(1, 4) == 1:
            selected_posts[i] += dm_message

    return selected_posts

# ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
yay_clients = []

for account in accounts:
    try:
        client = yaylib.Client()
        client.login(account["email"], account["password"])
        yay_clients.append(client)
        print(f"{account['email']} ã§ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ")
    except Exception as e:
        print(f"{account['email']} ã®ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—: {e}")

# ãƒ¡ã‚¤ãƒ³ã®æŠ•ç¨¿ãƒ«ãƒ¼ãƒ—
while True:
    try:
        client = random.choice(yay_clients)
        posts = get_time_based_posts()

        for post_content in posts:
            client.create_post(post_content)
            print(f'æŠ•ç¨¿ã—ã¾ã—ãŸ: {post_content}')
            time.sleep(900)

    except yaylib.errors.HTTPError as e:
        if "429" in str(e):
            wait_time = random.randint(600, 1800)
            print(f"429ã‚¨ãƒ©ãƒ¼: {wait_time} ç§’å¾…æ©Ÿã—ã¦å†è©¦è¡Œ")
            time.sleep(wait_time)
        else:
            print(f"ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {e}")
            break
